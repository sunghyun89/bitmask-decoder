<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>Bitmask Decoder</title>

<style>
  body {
    margin: 0;
    background: #0f111a;
    font-family: Arial, Helvetica, sans-serif;
    color: #e6e6e6;
  }

  .layout {
    display: flex;
    height: 100vh;
    min-width: 1200px; /* FHD 기준 */
  }

  /* ================= LEFT ================= */
  .main {
    flex: 1;
    padding: 24px;
    overflow-y: auto;
    min-width: 700px;
    max-width: 1000px;
  }

  h2 {
    margin-top: 0;
    color: #7aa2f7;
    font-size: 20px;
  }

  .desc {
    font-size: 13px;
    color: #9aa5ce;
    margin-bottom: 10px;
  }

  .input-box {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
  }

  input.hex {
    flex: 1;
    background: #1a1b26;
    color: #e6e6e6;
    border: 1px solid #3b4261;
    padding: 8px 10px;
    font-size: 15px;
    border-radius: 4px;
  }

  input::placeholder {
    color: #565f89;
  }

  /* button {
    background: #7aa2f7;
    border: none;
    color: #0f111a;
    font-weight: bold;
    padding: 8px 18px;
    cursor: pointer;
    border-radius: 4px;
  }

  button:hover {
    background: #89b4fa;
  } */

  pre {
    background: #1a1b26;
    border: 1px solid #3b4261;
    padding: 14px;
    border-radius: 6px;
    line-height: 1.45;
    font-size: 14px;
    white-space: pre-wrap;
  }

  /* ================= RIGHT HELP ================= */
  .help {
    width: 840px;
    border-left: 1px solid #3b4261;
    background: #11131d;
    padding: 16px;
    overflow-y: auto;
  }

  .help h3 {
    color: #7dcfff;
    padding-top: 0;
    font-size: 20px;
  }

  .help h4 {
    color: #f7768e;
    margin-bottom: 6px;
  }

  .help .item {
    font-size: 13px;
    margin-bottom: 6px;
    color: #c0caf5;
  }

  .help .mask {
    color: #9ece6a;
  }

  .help .group {
    margin-bottom: 18px;
  }

  .help-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
  }

  .help-header input {
    flex: 0 0 200px;
    background: #1a1b26;
    border: 1px solid #3b4261;
    color: #e6e6e6;
    padding: 6px 8px;
    font-size: 12px;
    border-radius: 4px;
  }

  .help-header input::placeholder {
    color: #565f89;
  }
</style>
</head>

<body>
<div class="layout">

  <!-- ================= LEFT ================= -->
  <div class="main">

    <h2>Bitmask Decoder</h2>

    <div class="desc">
      띄어쓰기로 구분 bitmask_ext_ext1<br><br>
      입력 예:<br>
      <code>0x98000000 0x00004001 0x82000000</code><br>
      또는<br>
      <code>98000000,4001,0x82000000</code>
    </div>

    <div class="input-box">
      <input id="hexAll" class="hex" placeholder="BITMASK  EXT  EXT1">
      <!-- <button onclick="applyHex()">Decode</button> -->
    </div>

    <pre id="result">No data</pre>
  </div>

  <!-- ================= RIGHT HELP ================= -->
  <div class="help">
    <div class="help-header">
      <h3>Bitmask Help</h3>
      <input id="helpSearch" placeholder="HEX SEARCH (ex: 80000000)" autocomplete="off">
    </div>
    <div id="helpBitmap"></div>
    <div id="helpExtBitmap"></div>
    <div id="helpExt1Bitmap"></div>
  </div>

</div>


<script>

  const BITMAP = [
    { mask: 0x00000003, type: "group", name: "Vehicle Hazard Type",
      items: [
        { bit: 0x00000000, label: "Hazard Lock" },
        { bit: 0x00000001, label: "Hazard Push" },
        { bit: 0x00000002, label: "Hazard Toggle" },
        { bit: 0x00000003, label: "Hazard Smart Key Lock" }
      ]
    },
    { mask: 0x0000000C, type: "group", name: "TailLamp Type",
      items: [
        { bit: 0x00000000, label: "Normal" },
        { bit: 0x00000008, label: "Reverse" }
      ]
    },
    { mask: 0x00000010, type: "group", name: "Validation of Direct-control for trunk",
      items: [
        { bit: 0x00000000, label: "Disable"},
        { bit: 0x00000010, label: "Enable"}
      ]
    },
    { mask: 0x000000E0, type: "group", name: "Fuel Type",
      items: [
        { bit: 0x00000000, label: "Gasoline" },
        { bit: 0x00000020, label: "LPG" },
        { bit: 0x00000040, label: "Diesel" },
        { bit: 0x00000060, label: "HEV" },
        { bit: 0x00000080, label: "EV" }
      ]
    },
    { mask: 0x00000100, type: "group", name: "Hazard Signal Enable Operation",
      items: [
        { bit: 0x00000000, label: "Active High"},
        { bit: 0x00000100, label: "Active Low"}
      ]
    },
    { mask: 0x00000200, type: "group", name: "Active High Operation of Door Lock State Signal",
      items: [
        { bit: 0x00000000, label: "Active High"},
        { bit: 0x00000200, label: "Active Low"}
      ]
    },
    { mask: 0x00000400, type: "group", name: "Active high operation of Door Lock Command Signal",
      items: [
        { bit: 0x00000000, label: "Normal"},
        { bit: 0x00000400, label: "Reverse"}
      ]
    },
    { mask: 0x00000800, type: "group", name: "Checking Door Lock status Only With the Driver's Front Door",
      items: [
        { bit: 0x00000000, label: "Normal"},
        { bit: 0x00000000, label: "FL Only"}
      ]
    },
    { mask: 0x00001000, type: "flag", name: "Avante MD does not check whether or not to check the trunk open status(No longer used)" },
    { mask: 0x00002000, type: "group", name: "Checking the door open status only with the driver's front door",
      items: [
        { bit: 0x00000000, label: "Normal"},
        { bit: 0x00002000, label: "FL Only"}
      ]
    },
    { mask: 0x0001C000, type: "group", name: "Airbag Veloster, Checking AIRBAG Status",
      items: [
        { bit: 0x00000000, label: "None" },
        { bit: 0x00004000, label: "Type1" },
        { bit: 0x00008000, label: "Type2" }
      ]
    },
    { mask: 0x000E0000, type: "group", name: "OBD Request Type (OBD2PID Applied, SM added)",
      items: [
        { bit: 0x00000000, label: "None" },
        { bit: 0x00020000, label: "Type1" },
        { bit: 0x00040000, label: "Type2 - Extended CANID -> FIAT" },
        { bit: 0x00060000, label: "Type3 - NoneRequest(SM3ZE)" }
      ]
    },
    { mask: 0x00F00000, type: "group", name: "CAN Mask Type",
      items: [
        { bit: 0x00000000, label: "None" },
        { bit: 0x00100000, label: "HK Type1" },
        { bit: 0x00200000, label: "HK Type2" },
        { bit: 0x00300000, label: "GM Type1 (Checked that bitmask is not used)" },
        { bit: 0x00400000, label: "SM Type1" },
        { bit: 0x00500000, label: "FULL" },
        { bit: 0x00600000, label: "GM Type2" },
        { bit: 0x00700000, label: "SM Type2 (QM3)" },
        { bit: 0x00800000, label: "FIAT Type1" },
        { bit: 0x00900000, label: "SM Type3 (QM5)" },
        { bit: 0x00A00000, label: "SM Type4 (SM3 ZE EV)" },
        { bit: 0x00B00000, label: "BMW-MINI Type1" },
        { bit: 0x00C00000, label: "BENZ-A Type1" },
        { bit: 0x00D00000, label: "FORD-MUSTANG Type1" },
        { bit: 0x00F00000, label: "Operates according to VEHICLE_ID" }
      ]
    },
    { mask: 0x01000000, type: "group", name: "Distance Get Type",
      items: [
        { bit: 0x00000000, label: "PULSE (PULSE from TIMER)"},
        { bit: 0x01000000, label: "CAN (CAN DATA)"}
      ]
    },
    { mask: 0x02000000, type: "group", name: "Distance Pulse Opt",
      items: [
        { bit: 0x00000000, label: "Disable (Pulse is not used even if DIGI_VINFO_DISTANCE_GET_PULSE is defined (default)"},
        { bit: 0x02000000, label: "Enable (Pulse is used even if DIGI_VINFO_DISTANCE_GET_PULSE is defined)"}
      ]
    },
    { mask: 0x04000000, type: "group", name: "Door Lock Control Type",
      items: [
        { bit: 0x00000000, label: "Dual (Direct control type Door Lock/Unlock GPIO is separated)"},
        { bit: 0x04000000, label: "Single (There is only one Door Lock/Unlock GPIO of direct control, and it is controlled by Toggle type)"}
      ]
    },
    { mask: 0x08000000, type: "group", name: "Hazard Oper Limit Time",
      items: [
        { bit: 0x00000000, label: "None"},
        { bit: 0x00000000, label: "On (Hazard is not turned on when it is operated for too short time. To make it work for at least 3 seconds (SM5))"}
      ]
    },
    { mask: 0xF0000000, type: "group", name: "Door Status Type",
      items: [
        { bit: 0x00000000, label: "IO (Normal Type)" },
        { bit: 0x20000000, label: "CAN SM Type1 (QM3)" },
        { bit: 0x30000000, label: "CAN SM Type2 (QM5)" },
        { bit: 0x40000000, label: "CAN SM Type3 (SM5)" },
        { bit: 0x50000000, label: "CAN SM Type4 (SM3 ZE EV)" },
        { bit: 0x60000000, label: "CAN HK Type1 (HG)" },
        { bit: 0x70000000, label: "CAN BMW Type1 (BMW)" },
        { bit: 0x80000000, label: "CAN BENZ-A Type1 (Benz-A)" }
      ]
    }
  ];


  const extBITMAP = [
    { mask: 0x00000001, type: "group", name: "Horn Control",
      items: [
        { bit: 0x00000000, label: "Normal (Horn Operation - GPIO)"},
        { bit: 0x00000001, label: "Reverse (Horn Operation - 12V OUT 1)"}
      ]
    },
    { mask: 0x00000002, type: "group", name: "RPM changed to Engine Run Time",
      items: [
        { bit: 0x00000000, label: "None (Normal Type)"},
        { bit: 0x00000002, label: "IF Engine Run Time does not appear in PID, pesudo Engine Run Time is created with RPM"}
      ]
    },
    { mask: 0x00000004, type: "group", name: "SOCAR-FIAT Door Lock Edge Sensing",
      items: [
        { bit: 0x00000000, label: "None (Normal Type)"},
        { bit: 0x00000004, label: "Type1 (Door lock status is recognized by the Interrupt Edge)"}
      ]
    },
    { mask: 0x00000020, type: "flag", name: "EV update SoC directly without filtering" },
    { mask: 0x00000040, type: "group", name: "Whether to connect ACC to CAR IO or use only CAN without using ACC",
      items: [
        { bit: 0x00000000, label: "ACC untie from CARIO (use only CAN without using ACC, or detect ACC automatically)"},
        { bit: 0x00000040, label: "ACC tie to CARIO (connect ACC to CAR IO)"}
      ]
    },
    { mask: 0x00000080, type: "group", name: "Odometer CAN Opt",
      items: [
        { bit: 0x00000000, label: "Update can odometer directly to OBD.Pulse_Cnt (default)"},
        { bit: 0x00000080, label: "None (Count by Pulse or Counter, This option is not used except in special cases, such as when the can odometer is incorrectly calculated depending on the vehicle)"}
      ]
    },
    { mask: 0x00000100, type: "group", name: "Door Lock/Unlock Edge Type",
      items: [
        { bit: 0x00000000, label: "None (Normal Type)"},
        { bit: 0x00000100, label: "Type1"}
      ]
    },
    { mask: 0x00000200, type: "group", name: "Door Open Status <br> Active Low (Open) - Normal, Active High (Open) - Ford Maker",
      items: [
        { bit: 0x00000000, label: "Active Low"},
        { bit: 0x00000200, label: "Active High"}
      ]
    },
    { mask: 0x00000400, type: "group", name: "It is not possible to reliably check the door lock/unlock status of the vehicle. <br> Status cannot be checked during direct control or autolock operation. (Disable Auto Retry Door Lock)",
      items: [
        { bit: 0x00000000, label: "Disable"},
        { bit: 0x00000400, label: "Enable"}
      ]
    },
    { mask: 0x00000800, type: "group", name: "If it is impossible to check the lock or unlock status, the status changes according to the control command",
      items: [
        { bit: 0x00000000, label: "Lock Conn Signal"},
        { bit: 0x00000800, label: "Lock Disconn Signal"}
      ]
    },
    { mask: 0x00001000, type: "group", name: "If the BIT below is enabled, ADC will be performed unconditionally",
      items: [
        { bit: 0x00000000, label: "HK Fuel Level AD None"},
        { bit: 0x00001000, label: "HK Fuel Level AD"}
      ]
    },
    { mask: 0x0023E000, type: "group", name: "Skip Check Door Open State",
      items: [
      { bit: 0x00002000, label: "LHD Front Left (FD)" },
      { bit: 0x00004000, label: "LHD Front Right (FP)" },
      { bit: 0x00008000, label: "LHD Rear Left (RD)" },
      { bit: 0x00010000, label: "LHD Rear Right (RP)" },
      { bit: 0x00020000, label: "Trunk (TR)" },
      { bit: 0x00200000, label: "SunRoof (SR)" },
      { bit: 0x0001C000, label: "Skip the remaining 3 doors to check only the front left (CHK_DOOR_OPEN_FRONLY)" }
    ]
    },
    { mask: 0x000C0000, type: "group", name: "Horn or Hazard control in remote control vehicle (no smart key)",
      items: [
        { bit: 0x00000000, label: "Alert Enable None" },
        { bit: 0x00040000, label: "Alert Enable Horn" },
        { bit: 0x00080000, label: "Alert Enable Hazard" }
      ]
    },
    { mask: 0x00100000, type: "group", name: "Hyundai Accent Hazard Control use 12V OUT EN2",
      items: [
        { bit: 0x00000000, label: "Normal (GPIOE -> GPIO PIN 7)"},
        { bit: 0x00100000, label: "12V OUT1 (GPIOE -> GPIO PIN 1)"}
      ]
    },
    { mask: 0x00400000, type: "group", name: "If the door is open, but it is locked, it will be unlocked automatically <br> It is controlled by single GPIO, but when the door lock is released in the vehicle, the unlocking may not be recognized depending on the vehicle. ex. 118D) <br> In this case, let's unlock it automatically.",
      items: [
        { bit: 0x00000000, label: "Disable"},
        { bit: 0x00400000, label: "Enable"}
      ]
    },
    { mask: 0x00800000, type: "group", name: "Does not change to percentage <br> Default : Change to Percentage <br> Amount of Fuel Level : BMW",
      items: [
        { bit: 0x00000000, label: "Enable"},
        { bit: 0x00800000, label: "Disable"}
      ]
    },
    { mask: 0x01000000, type: "group", name: "When separate processing is required according to the difference in Handle Position, <br> Ex) The position related to the door status is reversed (Hyundai Kia overseas vehicles)",
      items: [
        { bit: 0x00000000, label: "NO"},
        { bit: 0x01000000, label: "YES"}
      ]
    },
    { mask: 0x02000000, type: "group", name: "Disable feature to control directly if smart key control process is failed",
      items: [
        { bit: 0x00000000, label: "Enable"},
        { bit: 0x02000000, label: "Disable"}
      ]
    },
    { mask: 0x04000000, type: "group", name: "Disable anti-theft feature with transponderradiation if a user tries to lock the door",
      items: [
        { bit: 0x00000000, label: "Disable"},
        { bit: 0x04000000, label: "Enable"}
      ]
    },
    { mask: 0x08000000, type: "group", name: "Prevent entering sleep mode of the CAN Tranceiver in the device is in sleep mode",
      items: [
        { bit: 0x00000000, label: "Disable (default)"},
        { bit: 0x08000000, label: "Enable"}
      ]
    },
    { mask: 0x40000000, type: "group", name: "Door Control With Hazard (Play hazard and horn manually if the door lock is controled by the fob)",
      items: [
        { bit: 0x00000000, label: "Disable"},
        { bit: 0x40000000, label: "Enable (Play hazard and horn with fob control)"}
      ]
    },
    { mask: 0x80000000, type: "group", name: "CAN2 Mask Type",
      items: [
        { bit: 0x00000000, label: "CAN2 MASK - Vehicle ID"},
        { bit: 0x80000000, label: "CAN2 MASK - Full Accept All Msg"}
      ]
    }
  ];


  // const ext1BITMAP = [
  //   { mask: 0x02000000, type: "flag", name: "24V Battery Type" },
  //   { mask: 0x1C000000, type: "group", name: "Skip Engine Run Condition in OBD-II state machine",
  //     items: [
  //       { bit: 0x04000000, label: "BY_CAN DB" },
  //       { bit: 0x08000000, label: "BY_CAN" },
  //       { bit: 0x10000000, label: "BY_VOLT" }
  //     ]
  //   },
  //   { mask: 0x20000000, type: "flag", name: "ACC Enable, This feature is temporary (Only used by haup EV scooter)" },
  //   { mask: 0x40000000, type: "flag", name: "Single Button Smart Key" },
  //   { mask: 0x80000000, type: "flag", name: "Supported ISG, This feature is temporary" }
  // ];

  const ext1BITMAP = [
    { mask: 0x02000000, type: "group", name: "24V Battery Type",
      items: [
        { bit: 0x00000000, label: "None"},
        { bit: 0x02000000, label: "24V Batt Type"}
      ]
    },
    { mask: 0x1C000000, type: "group", name: "Skip Engine Run Condition in OBD-II state machine",
      items: [
        { bit: 0x00000000, label: "None" },
        { bit: 0x04000000, label: "BY_CAN DB" },
        { bit: 0x08000000, label: "BY_CAN" },
        { bit: 0x10000000, label: "BY_VOLT" }
      ]
    },
    { mask: 0x20000000, type: "group", name: "Replace the ACC state with door lock state, This feature is temporary (Only used by haup EV scooter)",
      items: [
        { bit: 0x00000000, label: "None"},
        { bit: 0x20000000, label: "Check Lock by ACC Enable"}
      ]
    },
    { mask: 0x40000000, type: "group", name: "Single Button Smart Key",
      items: [
        { bit: 0x00000000, label: "None (Normal Smart Key)"},
        { bit: 0x40000000, label: "Single (Single Button Smart Key)"}
      ]
    },
    { mask: 0x80000000, type: "group", name: "Supported ISG, This feature is temporary",
      items: [
        { bit: 0x00000000, label: "None (Not Supported ISG)"},
        { bit: 0x80000000, label: "Enable Supported ISG)"}
      ]
    }
  ];




  /* ================= CORE DECODE ================= */
  function decodeBitmap(value, bitmap) {
    let lines = [];

    bitmap.forEach(def => {

      // ===== FLAG =====
      if (def.type === "flag") {
        if (value & def.mask) {
          lines.push(def.name);
        }
        return;
      }

      // ===== GROUP =====
      if (def.type === "group") {
        const masked = value & def.mask;
        if (masked === 0) return;

        // ---------- ENUM 판단 ----------
        const enumItem = def.items.find(item => item.bit === masked);

        if (enumItem) {
          // ENUM
          lines.push(`${def.name}: ${enumItem.label}`);
        } else {
          // MULTI
          def.items.forEach(item => {
            if ((value & item.bit) === item.bit) {
              lines.push(`${def.name}: ${item.label}`);
            }
          });
        }
      }
    });

    return lines.length ? lines.join("\n") : "No flags set";
  }


  /* ================= INPUT PARSE ================= */
  function parseHex(str) {
    if (!str) return 0;
    const s = str.startsWith("0x") || str.startsWith("0X") ? str : "0x" + str;
    const v = parseInt(s, 16);
    if (Number.isNaN(v)) throw new Error(`Invalid hex value: ${str}`);
    return v >>> 0;
  }


  /* ================= APPLY ================= */

  function applyHex() {
    const raw = document.getElementById("hexAll").value.trim();
    if (!raw) {
      document.getElementById("result").textContent = "No data";
      return;
    }
    
    try {
      const parts = raw.split(/[,\s]+/);
      
      const bitmap     = parseHex(parts[0]);
      const extbitmap  = parseHex(parts[1]);
      const ext1bitmap = parseHex(parts[2]);
      
      let out = [];
      
      out.push("[ Bitmask ]");
      out.push(decodeBitmap(bitmap, BITMAP));
      out.push("");
      out.push("[ EXT Bitmask ]");
      out.push(decodeBitmap(extbitmap, extBITMAP));
      out.push("");
      out.push("[ EXT1 Bitmask ]");
      out.push(decodeBitmap(ext1bitmap, ext1BITMAP));
      
      document.getElementById("result").textContent = out.join("\n");
      
    } catch (e) {
      document.getElementById("result").textContent ="[ Invalid Input ]\n" + e.message;
    }
  }


  /* ================= DECODE BY HEX INPUT ================= */
  const hexInput = document.getElementById("hexAll");

  hexInput.addEventListener("input", () => {
    applyHex();
  });


  /* ================= DECODE BY ENTER ================= */
  // document.addEventListener("keydown", function (e) {
  //   if (e.key === "Enter") {
  //     applyHex();
  //   }
  // });


  /* ================= HELP RENDER ================= */
  function renderHelp(title, bitmap, targetId, searchHex = null) {
    const root = document.getElementById(targetId);
    let html = `<h4>${title}</h4>`;
    let found = false;

    bitmap.forEach(def => {

      const defMaskHex = def.mask.toString(16).toUpperCase();
      let matchGroup = !searchHex || defMaskHex.includes(searchHex);

      let itemHtml = "";

      if (def.type === "group") {
        def.items.forEach(it => {
          const bitHex = it.bit.toString(16).toUpperCase();
          if (!searchHex || bitHex.includes(searchHex)) {
            matchGroup = true;
            itemHtml += `
              <div class="item">
                └ ${it.label}
                <span class="mask">(0x${bitHex})</span>
              </div>`;
          }
        });
      }

      if (matchGroup) {
        found = true;
        html += `
          <div class="group">
            <div class="item">
              <span class="mask">
                0x${def.mask.toString(16).padStart(8,"0").toUpperCase()}
              </span>
              ${def.name}
            </div>
            ${itemHtml}
          </div>`;
      }
    });

    root.innerHTML = found ? html : `<h4>${title}</h4><div class="item">NO MATCH</div>`;
  }


  /* ================= HELP SEARCH ================= */
  const searchInput = document.getElementById("helpSearch");

  searchInput.addEventListener("input", () => {
    let v = searchInput.value.trim().toUpperCase();

    if (v.startsWith("0X")) v = v.slice(2);

    if (v === "") {
      renderHelp("Bitmap", BITMAP, "helpBitmap");
      renderHelp("EXT Bitmap", extBITMAP, "helpExtBitmap");
      renderHelp("EXT1 Bitmap", ext1BITMAP, "helpExt1Bitmap");
      return;
    }

    renderHelp("Bitmap", BITMAP, "helpBitmap", v);
    renderHelp("EXT Bitmap", extBITMAP, "helpExtBitmap", v);
    renderHelp("EXT1 Bitmap", ext1BITMAP, "helpExt1Bitmap", v);
  });


  /* ================= BEGIN RENDER ================= */
  document.addEventListener("DOMContentLoaded", () => {
    renderHelp("Bitmap", BITMAP, "helpBitmap");
    renderHelp("EXT Bitmap", extBITMAP, "helpExtBitmap");
    renderHelp("EXT1 Bitmap", ext1BITMAP, "helpExt1Bitmap");
  });

</script>

</body>
</html>
